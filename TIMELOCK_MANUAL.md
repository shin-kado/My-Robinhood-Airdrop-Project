# TimeLockAirdrop（タイムロック配布）操作マニュアル  
<br>

### 📖 機能説明
この手順書は、**Remix**を使用して、指定した期間が経過するまで引き出しを制限する**「タイムロック機能付き配布（TimeLockAirdrop）」**を安全に実行するための標準マニュアルです。特定の解凍日時（Unix Time）を設定し、計画的なトークン配布を管理する際に使用します。
<BR>

> [!IMPORTANT]
> 本プロジェクトはテストネット用です。  
> **MetaMaskで赤い警告（エラー）が表示された場合**
> 入力したアドレスや数値、あるいはロック解除時間の設定が正しくない可能性があります。そのまま実行するとガス代のみが消費されるため、必ず一度「拒否」をクリックし、マニュアルの手順に従って入力内容を再確認してください。
<br>

　ソースコード　　　　　　　　 ：[TimeLockAirdrop](./TimeLockAirDrop.sol)  
　フラット化済みコード (Verify用)：[TimeLockAirdrop_flattened](./TimeLockAirDrop_flattened.sol)  
<br>

### 基礎知識：Unixタイムスタンプとは？  

ブロックチェーンで「時間」を指定するための共通ルールです。  
　　• 考え方: 1970年1月1日から「現在までに何秒経過したか」という秒数で表します。  
　　• 現在の秒数（例）: 1772071200 前後（2026年2月26日現在）。  
　　• 計算方法:  

| 目的時間 | 現在のUnixタイムスタンプにプラスする数値 | 補足 |
| :--- | :--- | :--- |
| １分後 | 60 | 60秒 |
| １０分後 | 600 | 60秒 × 10分 |
| １時間後 | 3600 | 600秒 × 600分 |
| １日後 | 86400 | 3600秒 × 24時間 |
| １週間後 | 604800 | 86400秒 × 7日 |
| １か月後 | 2592000 | 604800秒 × 30日 |
| １年後 | 31536000 | 2592000秒 × 365日 |
<br>

　　• 上記表を参考にしてUnixタイムスタンプを計算するかwebページで直接時間を設定して確認する  
　　　　　[https://www.unixtimestamp.com/](https://www.unixtimestamp.com/)  
<br>

## ステップ 1：コントラクトのデプロイ  
### 　　1. Remix: TimeLockAirdrop.sol のタブを開き、左メニューの「Solidity Compiler」で Compile を押します。  
### 　　2. 接続設定: 「Deploy & Run Transactions」タブで ENVIRONMENT を確認する。  
　　　　　　・Injected Provider - MetaMask  
　　　　　　・ネットワークが Custom (46630) であることを確認します。  
### 　　3. デプロイ実行: CONTRACT 欄で TimeLockAirdrop を選択し、Deploy ボタンを押します。  
### 　　4. アドレスの保存: 画面下に表示された TIMELOCKAIRDROP AT 0x... のアドレスをコピーしておきます。
<br>

## ステップ 2：トークンの使用許可（Approve）  
<br>

### 　　※重要：送りたいトークン（TSLAなど）のパネルで操作します。  
### 　　1. TSLA（またはMRT）のパネルを開き、approve 関数を表示します。  
### 　　2. spender: 先ほどコピーした TimeLockAirdropのアドレス を貼り付けます。  
### 　　3. value: 送る合計数量（18桁の0を付ける。例：1枚なら 1000000000000000000）。  
### 　　4. transact を押し、MetaMaskで「最大使用上限」を承認します。  
<br>

## ステップ 3：タイムロック配布の実行（depositLockedTokens）  
### 　　1. TimeLockAirdrop のパネルを開き、depositLockedTokens を展開します。  
### 　　2. 各項目を次のように入力します：  
　　　　　　・ tokenAddress: TSLA（またはMRT）のアドレス。  
　　　　　　・ recipients: ["送付先アドレス"]   
　　　　　　・ amounts: [1000000000000000000] （1枚送る場合）  
　　　　　　・ unlockTime: 解除したい時間の数値 を入力します。  
　　　　　　　　【テスト用おすすめ】  
　　　　　　　　　　Unix Time Converter で現在の秒数を確認し、そこに 600（10分）足した数値を入力してください。  
### 　　3. transact を押して確定させます。  
<br>

###	　　＊ 自分の指定した内容でロックされているか確認  
<br>
　　　　userLockBoxes 関数を使う:  
	
　　　　　　• TimeLockAirdrop のパネルの一番下あたりにある userLockBoxes を探します。  
	  
　　　　　　• address: 受取人に指定したあなたのアドレス（0xD22...）を貼り付けます。  
	  
　　　　　　• uint256: 0 を入力します（そのアドレスにとっての1番目のロック箱という意味です）。  
<br>
　　　　青色の call ボタンを押します。  
　　　　　※ call はブロックチェーンのデータを「読み取るだけ」の操作なのでガス代（ETH）はかかりません。  
　　　　　　何度実行しても無料です。  
<br>

### userLockBoxes 表示結果の見方  

| 項目 | 意味 | 解説 |
| :--- | :--- | :--- |
| address tokenAddress | トークンの住所 | ロックされているトークン（TSLAなど）のコントラクトアドレスです |
| uint256 amount | 預け入れ数量 | 18桁の単位（wei）で表示されます（例: 1枚 = 1000000000000000000） |
| uint256 unlockTime | ロック解除時間 | Unixタイムスタンプ形式の数値です。この数値が現在の時間を過ぎるまで引き出せません |
| bool claimed | 回収済みフラグ | false : まだ金庫にトークンが入っています。解除時間を過ぎていれば claim 可能です <br>true : すでに引き出しが完了しています。この番号で再度 claim することはできません |
<br>
<br>

## ステップ 4：トークンの引き出し（Claim）  
<br>
　　ロック時間が経過した後に、**「受取人」**が以下の操作を行います。  
<br>

### 　　1. アカウント切り替え  
　　　　　　MetaMaskを受取人のアドレスに切り替えます。  
### 　　2. 引き出し実行  
　　　　　　TimeLockAirdrop パネルの claim 関数に 0 （一番最初の箱を指します）と入力して実行します。  
### 　　3. 結果確認  
　　　　　　受取人のウォレットにトークンが届いていれば成功です！  
<br>

### 　　【失敗事例のメモ】  
　　　　　送金側のアカウントのまま claim を実行しようとすると、コントラクトの権限チェックにより拒否される。  
　　　　　この際にトークンは移動しないが、実行した側（送金側）のETHがガス代として無駄に消費される。  
　　　　　アカウントの切り替え忘れに注意すること。 
<br>
### 　　💡 ヒント：Unixタイムスタンプの取得  
　　　　　　　今すぐテストしたい場合は、以下の数値を unlockTime に入力してみてください（現在の時刻を基準に算出）。  
	   
　　　　　　　　　• 今から約10分後: 1740536400 辺りの数値  

　　　　　　　※もし「Unlock time must be in the future」とエラーが出た場合は、この数値にさらに 600 を足してください。  
<br>
## 受け取り失敗したときの確認方法  

### 1. 必要情報の入力  

　　　userLockBoxes 関数の横にある下矢印（∨）をクリックして入力欄を広げ、以下の2項目を入力します。  
　　　　　• address: トークンの受取人（recipient）として指定したウォレットアドレスを貼り付けます。  
　　　　　• uint256: インデックス番号（箱の番号）を入力します。  
　　　　　　　◦ そのアドレスに対して1回目の配布なら 0  
　　　　　　　◦ 2回目なら 1、3回目なら 2 ...と順番に増えていきます。  
<br>
### 2. call ボタンの実行  

　　　　青色の call ボタンを押します。  
	
　　　　※ call はブロックチェーンのデータを「読み取るだけ」の操作なので、ガス代（ETH）はかかりません。  
　　　　　何度実行しても無料です。  

<br>

### 　　📊 表示結果の読み解き方  

　　　　　上記表userLockBoxes 表示結果の見方を参照して確認してください。  
<br>

### 　　💡 claimed の状態判定  

　　　　　　• false: まだ金庫にトークンが入っています。解除時間を過ぎていれば claim 可能です。  
　　　　　　• true: すでに引き出しが完了しています。この番号で再度 claim することはできません。  
<br>

### 　　⚠️ エラーが出る場合の判断基準  

　　　　call を押した際に Remix のコンソール（下の黒い画面）に execution reverted というエラーが出た場合  

　　　　　「そのインデックス番号の金庫は存在しません」  という状態を指します

　　　　≪例≫  
　　　　　インデックス 2 まではデータが出るのに 3 でエラーになる。  
　　　　　その場合はその受取人には合計３回しか送金されていないことが分かります。  
<br>

### 　　💡 トラブル防止のコツ  

　　　　　claim（回収）が失敗したときは、まず userLockBoxes で claimed が true になっていないか確認しましょう。  
　　　　　もし true なら、それは「失敗」ではなく「すでに受け取り済み」という成功の証です。 
